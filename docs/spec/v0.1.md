# Spec v0.1

specloom の Definition Spec 仕様です。

## 概要

TypeSpec で定義 → JSON にコンパイル → 各言語で利用

```
TypeSpec (ユーザーが書く)
    ↓ コンパイル
JSON Spec (v0.1)
    ↓ 評価
ViewModel
```

## TypeSpec での定義

### Resource

```typespec
@resource
@label("投稿")
model Post {
  @readonly
  id: string;

  @label("タイトル")
  @kind("text")
  @required
  @maxLength(100)
  title: string;

  @label("状態")
  @kind("enum")
  @ui(#{ hint: "badge", inputHint: "select" })
  @options(#[
    #{ value: "draft", label: "下書き" },
    #{ value: "published", label: "公開中" }
  ])
  status: string;

  @label("著者")
  @kind("relation")
  @relation(User, #{ labelField: "name" })
  @ui(#{ hint: "avatar", inputHint: "autocomplete" })
  @required
  author: User;

  @label("作成日時")
  @kind("datetime")
  @readonly
  createdAt: utcDateTime;
}
```

### List View

```typespec
@view(Post, "list")
@columns(["title", "status", "author", "createdAt"])
@searchable(["title", "body"])
@sortable(["title", "createdAt"])
@defaultSort("createdAt", "desc")
@selection("multi")  // JSON: selectionMode
@clickAction("show")
@namedFilter("all", "すべて", #{})
@namedFilter("published", "公開中", #{ field: "status", operator: "eq", value: "published" })
@namedFilter("draft", "下書き", #{ field: "status", operator: "eq", value: "draft" })
model PostList {
  // Page action
  @action("create")
  @label("新規作成")
  @allowedWhen("role == 'admin' || role == 'editor'")
  @ui(#{ icon: "plus", variant: "primary" })
  create: never;

  // Bulk action
  @action("bulkDelete")
  @label("一括削除")
  @requiresSelection("selected")  // JSON: selection
  @allowedWhen("role == 'admin'")
  @confirm("選択した項目を削除しますか？")
  bulkDelete: never;

  // Row action
  @rowAction("delete")
  @label("削除")
  @allowedWhen("role == 'admin'")
  @confirm("本当に削除しますか？")
  @ui(#{ icon: "trash", variant: "danger" })
  delete: never;
}
```

### Form View

```typespec
@view(Post, "form")
@fields(["title", "body", "status", "author"])
model PostForm {
  @action("save")
  @label("保存")
  @ui(#{ icon: "check", variant: "primary" })
  save: never;

  @action("cancel")
  @label("キャンセル")
  cancel: never;
}
```

### Show View

```typespec
@view(Post, "show")
@fields(["title", "body", "status", "author", "createdAt"])
model PostShow {
  @action("edit")
  @label("編集")
  @allowedWhen("role == 'admin' || role == 'editor'")
  @ui(#{ icon: "pencil" })
  edit: never;

  @action("publish")
  @label("公開")
  @allowedWhen("status == 'draft'")
  @ui(#{ icon: "globe", variant: "primary" })
  publish: never;
}
```

## コンパイル結果 (JSON)

TypeSpec からコンパイルされる JSON の構造です。

> **Note**: 通常は TypeSpec を使います。JSON を直接書く必要はありません。

### 全体構造

```json
{
  "version": "0.1",
  "resources": [...],
  "views": [...]
}
```

### Resource

```json
{
  "name": "Post",
  "label": "投稿",
  "fields": [
    {
      "name": "id",
      "type": "string",
      "readonly": true
    },
    {
      "name": "title",
      "type": "string",
      "label": "タイトル",
      "kind": "text",
      "required": true,
      "validation": {
        "maxLength": 100
      }
    },
    {
      "name": "status",
      "type": "string",
      "label": "状態",
      "kind": "enum",
      "ui": {
        "hint": "badge",
        "inputHint": "select"
      },
      "options": [
        { "value": "draft", "label": "下書き" },
        { "value": "published", "label": "公開中" }
      ]
    },
    {
      "name": "author",
      "type": "User",
      "label": "著者",
      "kind": "relation",
      "required": true,
      "relation": {
        "resource": "User",
        "labelField": "name"
      },
      "ui": {
        "hint": "avatar",
        "inputHint": "autocomplete"
      }
    },
    {
      "name": "createdAt",
      "type": "datetime",
      "label": "作成日時",
      "kind": "datetime",
      "readonly": true
    }
  ]
}
```

### List View

```json
{
  "resource": "Post",
  "type": "list",
  "columns": ["title", "status", "author", "createdAt"],
  "searchable": ["title", "body"],
  "sortable": ["title", "createdAt"],
  "defaultSort": {
    "field": "createdAt",
    "order": "desc"
  },
  "selectionMode": "multi",
  "clickAction": "show",
  "namedFilters": [
    { "id": "all", "label": "すべて", "filter": {} },
    { "id": "published", "label": "公開中", "filter": { "field": "status", "operator": "eq", "value": "published" } },
    { "id": "draft", "label": "下書き", "filter": { "field": "status", "operator": "eq", "value": "draft" } }
  ],
  "actions": [
    {
      "id": "create",
      "label": "新規作成",
      "allowedWhen": "role == 'admin' || role == 'editor'",
      "ui": { "icon": "plus", "variant": "primary" }
    },
    {
      "id": "bulkDelete",
      "label": "一括削除",
      "selection": "selected",
      "allowedWhen": "role == 'admin'",
      "confirm": "選択した項目を削除しますか？"
    }
  ],
  "rowActions": [
    {
      "id": "delete",
      "label": "削除",
      "allowedWhen": "role == 'admin'",
      "confirm": "本当に削除しますか？",
      "ui": { "icon": "trash", "variant": "danger" }
    }
  ]
}
```

`confirm` は次の2形を取れます。

- `true`: メッセージは i18n 側で解決
- `string`: 固定メッセージを使用

### Form View

```json
{
  "resource": "Post",
  "type": "form",
  "fields": ["title", "body", "status", "author"],
  "actions": [
    {
      "id": "save",
      "label": "保存",
      "ui": { "icon": "check", "variant": "primary" }
    },
    {
      "id": "cancel",
      "label": "キャンセル"
    }
  ]
}
```

### Show View

```json
{
  "resource": "Post",
  "type": "show",
  "fields": ["title", "body", "status", "author", "createdAt"],
  "actions": [
    {
      "id": "edit",
      "label": "編集",
      "allowedWhen": "role == 'admin' || role == 'editor'",
      "ui": { "icon": "pencil" }
    },
    {
      "id": "publish",
      "label": "公開",
      "allowedWhen": "status == 'draft'",
      "ui": { "icon": "globe", "variant": "primary" }
    }
  ]
}
```

## フィールド型

| TypeSpec 型 | JSON type | 説明 |
|-------------|-----------|------|
| `string` | `"string"` | 文字列 |
| `int32` | `"int32"` | 整数 |
| `float64` | `"float64"` | 小数 |
| `boolean` | `"boolean"` | 真偽値 |
| `plainDate` | `"date"` | 日付 |
| `utcDateTime` | `"datetime"` | 日時 |
| `Model` | `"Model"` | 単一リレーション |
| `Model[]` | `"Model[]"` | 複数リレーション |

## バリデーション

TypeSpec:
```typespec
@required
@minLength(1)
@maxLength(100)
title: string;
```

JSON:
```json
{
  "name": "title",
  "required": true,
  "validation": {
    "minLength": 1,
    "maxLength": 100
  }
}
```

| デコレーター | validation プロパティ |
|-------------|---------------------|
| `@required` | `required: true` (フィールド直下) |
| `@minLength(n)` | `minLength: n` |
| `@maxLength(n)` | `maxLength: n` |
| `@minValue(n)` | `min: n` |
| `@maxValue(n)` | `max: n` |
| `@pattern(p)` | `pattern: p` |
| `@minItems(n)` | `minItems: n` |
| `@maxItems(n)` | `maxItems: n` |

## 条件付き表示・必須

フィールドに条件式を設定できます。`allowedWhen` と同じ式言語を使います。

TypeSpec:
```typespec
@visibleWhen("status == 'published'")
publishedAt?: plainDate;

@requiredWhen("type == 'external'")
url: string;
```

JSON:
```json
{
  "name": "publishedAt",
  "type": "date",
  "visibleWhen": "status == 'published'"
}
```

```json
{
  "name": "url",
  "type": "string",
  "requiredWhen": "type == 'external'"
}
```

| デコレーター | JSON プロパティ | 評価結果 |
|-------------|----------------|---------|
| `@visibleWhen(expr)` | `visibleWhen: expr` | `visible: boolean` |
| `@requiredWhen(expr)` | `requiredWhen: expr` | `required: boolean`（`@required` と OR） |

## TypeScript 型定義

コンパイルされた JSON を扱う型は `packages/specloom/src/spec/index.ts` で定義されています。

## 関連ドキュメント

- [TypeSpec Guide](../typespec/README.md) - TypeSpec での定義方法
- [ViewModel Spec](./view_model.md) - 評価後の ViewModel 仕様
- [Filter Spec](./filter.md) - フィルター式の仕様
